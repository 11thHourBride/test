<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SusuPay - Admin Dashboard</title>
   <style>  * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .admin-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 0;
        }

        .admin-badge {
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-left: 10px;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 10px 20px;
            background: #f7fafc;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #c53030;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.users { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.kyc { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.transactions { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.revenue { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stat-icon.complaints { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-content p {
            color: #718096;
            font-weight: 600;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 8px;
        }

        .stat-change.positive { color: #38a169; }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            color: #2d3748;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
        }

        .btn-approve {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-approve:hover {
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn-reject {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-reject:hover {
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #4a5568;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-input, .filter-select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            flex: 1;
            min-width: 200px;
        }

        .search-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th {
            background: #f7fafc;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
        }

        .user-email {
            font-size: 0.875rem;
            color: #718096;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fed7d7; color: #742a2a; }
        .status-approved { background: #c6f6d5; color: #22543d; }
        .status-rejected { background: #fed7d7; color: #742a2a; }
        .status-verified { background: #bee3f8; color: #2a4365; }
        .status-not-started { background: #f7fafc; color: #4a5568; }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #e53e3e;
        }

        .document-preview {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .document-image {
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
        }

        .page-btn:hover {
            background: #f7fafc;
        }

        .page-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: #f7fafc;
            border-radius: 10px;
            color: #718096;
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 10px;
            }

            .admin-header {
                padding: 15px 20px;
                flex-direction: column;
                align-items: stretch;
            }

            .admin-nav {
                justify-content: center;
            }

            .main-content {
                padding: 20px;
            }

            .search-filter {
                flex-direction: column;
            }

            .search-input, .filter-select {
                min-width: unset;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
                max-height: 85vh;
            }
        }</style>
</head>
<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <div>
                <h1>
                    üè¶ SusuPay Admin
                    <span class="admin-badge">ADMIN PANEL</span>
                </h1>
                <p style="color: #718096; margin-top: 10px;">Comprehensive platform management and user oversight</p>
                <div class="stat-card">
                    <div class="stat-icon complaints">üìû</div>
                    <div class="stat-content">
                        <h3 id="pending-complaints">0</h3>
                      <div class="stat-change" id="complaints-change">Awaiting response</div>
                    </div>
                </div>
            </div>
            <div class="admin-nav">
                <button class="nav-item active" data-section="dashboard">
                    üìä Dashboard
                </button>
                <button class="nav-item" data-section="users">
                    üë• Users
                </button>
                <button class="nav-item" data-section="kyc">
                    üõ°Ô∏è KYC Review
                </button>
                <button class="nav-item" data-section="approvals">
                    ‚è≥ Approvals
                </button>
                <button class="nav-item" data-section="transactions">
                    üí∞ Transactions
                </button>
                <button class="nav-item" data-section="complaints">
                    üìû Complaints
                </button>
                <button class="nav-item" data-section="reports">
                    üìà Reports
                </button>
                <button class="logout-btn" id="admin-logout">
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon users">üë•</div>
                <div class="stat-content">
                    <h3 id="total-users">0</h3>
                    <p>Total Users</p>
                    <div class="stat-change positive" id="users-change">+0 this month</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon kyc">üõ°Ô∏è</div>
                <div class="stat-content">
                    <h3 id="pending-kyc">0</h3>
                    <p>Pending KYC</p>
                    <div class="stat-change" id="kyc-change">Awaiting review</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon transactions">üí∞</div>
                <div class="stat-content">
                    <h3 id="total-transactions">‚Çµ0</h3>
                    <p>Total Volume</p>
                    <div class="stat-change positive" id="volume-change">+‚Çµ0 today</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon revenue">üìà</div>
                <div class="stat-content">
                    <h3 id="platform-revenue">‚Çµ0</h3>
                    <p>Platform Revenue</p>
                    <div class="stat-change positive" id="revenue-change">+‚Çµ0 this month</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div class="section active" id="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">
                        üìä Platform Overview
                    </h2>
                    <button class="btn" onclick="refreshDashboard()">
                        üîÑ Refresh Data
                    </button>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="recent-activity">Recent Activity</button>
                    <button class="tab" data-tab="analytics">Analytics</button>
                    <button class="tab" data-tab="system-health">System Health</button>
                </div>

                <div class="tab-content active" id="recent-activity">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="recent-activity-table">
                                <tr>
                                    <td colspan="5" class="empty-state">
                                        <div class="empty-state-icon">üìã</div>
                                        <p>No recent activity to display</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content" id="analytics">
                    <div class="chart-container">
                        <div>üìä Analytics charts will be displayed here</div>
                    </div>
                </div>

                <div class="tab-content" id="system-health">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="padding: 20px; background: #f0fff4; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; color: #38a169; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-weight: 600; color: #22543d;">Database</div>
                            <div style="color: #68d391; font-size: 0.9rem;">Operational</div>
                        </div>
                        <div style="padding: 20px; background: #f0fff4; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; color: #38a169; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-weight: 600; color: #22543d;">Authentication</div>
                            <div style="color: #68d391; font-size: 0.9rem;">Operational</div>
                        </div>
                        <div style="padding: 20px; background: #f0fff4; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; color: #38a169; margin-bottom: 10px;">‚úÖ</div>
                            <div style="font-weight: 600; color: #22543d;">File Storage</div>
                            <div style="color: #68d391; font-size: 0.9rem;">Operational</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="section" id="users-section">
                <div class="section-header">
                    <h2 class="section-title">
                        üë• User Management
                    </h2>
                    <button class="btn" onclick="exportUsers()">
                        üì• Export Users
                    </button>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="user-search" placeholder="Search users by name, email, or phone...">
                    <select class="filter-select" id="user-status-filter">
                        <option value="">All Statuses</option>
                        <option value="verified">Email Verified</option>
                        <option value="unverified">Email Unverified</option>
                    </select>
                    <select class="filter-select" id="kyc-status-filter">
                        <option value="">All KYC Status</option>
                        <option value="not_started">Not Started</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>

                <div class="loading" id="users-loading">
                    <div class="spinner"></div>
                    <p>Loading users...</p>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Country</th>
                                <th>Phone</th>
                                <th>Balance</th>
                                <th>KYC Status</th>
                                <th>Email Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="users-pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>

            <!-- Approvals Section -->
            <div class="section" id="approvals-section">
                <div class="section-header">
                    <h2 class="section-title">
                        ‚è≥ Pending Approvals
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="refreshApprovals()">
                            üîÑ Refresh
                        </button>
                        <button class="btn" onclick="approveAllSelected()" id="approve-all-btn" style="background: #38a169; display: none;">
                            ‚úÖ Approve Selected
                        </button>
                    </div>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="approval-search" placeholder="Search by user name or email...">
                    <select class="filter-select" id="approval-type-filter">
                        <option value="">All Types</option>
                        <option value="contribution">Contributions</option>
                        <option value="withdrawal">Withdrawals</option>
                    </select>
                    <select class="filter-select" id="approval-amount-filter">
                        <option value="">All Amounts</option>
                        <option value="small">Under ‚Çµ100</option>
                        <option value="medium">‚Çµ100 - ‚Çµ500</option>
                        <option value="large">Over ‚Çµ500</option>
                    </select>
                </div>

                <div class="loading" id="approvals-loading">
                    <div class="spinner"></div>
                    <p>Loading pending approvals...</p>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all-approvals" onchange="toggleAllApprovals(this)">
                                </th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Requested</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="approvals-table">
                            <!-- Approvals will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Complaints Section -->
            <div class="section" id="complaints-section">
                <div class="section-header">
                    <h2 class="section-title">
                        üìû Customer Complaints
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <select class="filter-select" id="complaints-status-filter">
                            <option value="">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                        <select class="filter-select" id="complaints-category-filter">
                            <option value="">All Categories</option>
                            <option value="login_auth">Login/Authentication</option>
                            <option value="transaction">Transaction Problems</option>
                            <option value="kyc">KYC Verification</option>
                            <option value="technical">Technical Problems</option>
                            <option value="other">Other</option>
                        </select>
                        <button class="btn" onclick="refreshComplaints()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="complaints-search" placeholder="Search by user name, email, or complaint description...">
                    <select class="filter-select" id="complaints-priority-filter">
                        <option value="">All Priorities</option>
                        <option value="high">High Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="low">Low Priority</option>
                    </select>
                    <input type="date" class="filter-select" id="complaints-date-from" style="width: auto;" placeholder="From Date">
                    <input type="date" class="filter-select" id="complaints-date-to" style="width: auto;" placeholder="To Date">
                </div>

                <div class="loading" id="complaints-loading">
                    <div class="spinner"></div>
                    <p>Loading complaints...</p>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Category</th>
                                <th>Priority</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Date Reported</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="complaints-table">
                            <!-- Complaints will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="complaints-pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>

            <!-- KYC Review Section -->
            <div class="section" id="kyc-section">
                <div class="section-header">
                    <h2 class="section-title">
                        üõ°Ô∏è KYC Verification Review
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <select class="filter-select" id="kyc-filter">
                            <option value="pending">Pending Review</option>
                            <option value="all">All Submissions</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <button class="btn" onclick="refreshKYC()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                <div class="loading" id="kyc-loading">
                    <div class="spinner"></div>
                    <p>Loading KYC submissions...</p>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Submitted</th>
                                <th>Documents</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="kyc-table">
                            <!-- KYC submissions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Transactions Section -->
            <div class="section" id="transactions-section">
                <div class="section-header">
                    <h2 class="section-title">
                        üí∞ Transaction Monitor
                    </h2>
                    <div style="display: flex; gap: 10px;">
                        <select class="filter-select" id="transaction-type-filter">
                            <option value="">All Types</option>
                            <option value="contribution">Contributions</option>
                            <option value="withdrawal">Withdrawals</option>
                        </select>
                        <button class="btn" onclick="exportTransactions()">
                            üì• Export
                        </button>
                    </div>
                </div>

                <div class="search-filter">
                    <input type="text" class="search-input" id="transaction-search" placeholder="Search by user or transaction ID...">
                    <input type="date" class="filter-select" id="date-from" style="width: auto;">
                    <input type="date" class="filter-select" id="date-to" style="width: auto;">
                </div>

                <div class="loading" id="transactions-loading">
                    <div class="spinner"></div>
                    <p>Loading transactions...</p>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Commission</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table">
                            <!-- Transactions will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="transactions-pagination">
                    <!-- Pagination will be populated here -->
                </div>
            </div>

            <!-- Reports Section -->
            <div class="section" id="reports-section">
                <div class="section-header">
                    <h2 class="section-title">
                        üìà Reports & Analytics
                    </h2>
                    <button class="btn" onclick="generateReports()">
                        üìä Generate Report
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <div style="padding: 25px; border: 2px solid #e2e8f0; border-radius: 15px;">
                        <h3 style="color: #4a5568; margin-bottom: 15px;">üìä User Growth</h3>
                        <div class="chart-container" style="height: 200px;">
                            User growth chart placeholder
                        </div>
                    </div>
                    <div style="padding: 25px; border: 2px solid #e2e8f0; border-radius: 15px;">
                        <h3 style="color: #4a5568; margin-bottom: 15px;">üí∞ Revenue Trends</h3>
                        <div class="chart-container" style="height: 200px;">
                            Revenue trends chart placeholder
                        </div>
                    </div>
                    <div style="padding: 25px; border: 2px solid #e2e8f0; border-radius: 15px;">
                        <h3 style="color: #4a5568; margin-bottom: 15px;">üõ°Ô∏è KYC Completion</h3>
                        <div class="chart-container" style="height: 200px;">
                            KYC completion chart placeholder
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="daily-report">Daily Report</button>
                    <button class="tab" data-tab="monthly-report">Monthly Report</button>
                    <button class="tab" data-tab="custom-report">Custom Report</button>
                </div>

                <div class="tab-content active" id="daily-report">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="padding: 20px; background: #f7fafc; border-radius: 10px;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">Today's Registrations</h4>
                            <div style="font-size: 2rem; font-weight: 700; color: #667eea;" id="today-registrations">0</div>
                        </div>
                        <div style="padding: 20px; background: #f7fafc; border-radius: 10px;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">Today's Transactions</h4>
                            <div style="font-size: 2rem; font-weight: 700; color: #48bb78;" id="today-transactions">‚Çµ0</div>
                        </div>
                        <div style="padding: 20px; background: #f7fafc; border-radius: 10px;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">KYC Submissions</h4>
                            <div style="font-size: 2rem; font-weight: 700; color: #f093fb;" id="today-kyc">0</div>
                        </div>
                        <div style="padding: 20px; background: #f7fafc; border-radius: 10px;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">Platform Revenue</h4>
                            <div style="font-size: 2rem; font-weight: 700; color: #ed8936;" id="today-revenue">‚Çµ0</div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="monthly-report">
                    <div class="chart-container">
                        <div>üìä Monthly analytics charts will be displayed here</div>
                    </div>
                </div>

                <div class="tab-content" id="custom-report">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Report Type</label>
                            <select class="filter-select" id="custom-report-type" style="width: 100%;">
                                <option value="users">User Activity Report</option>
                                <option value="transactions">Transaction Analysis</option>
                                <option value="kyc">KYC Performance</option>
                                <option value="revenue">Revenue Analysis</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Date Range</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" class="filter-select" id="custom-date-from" style="flex: 1;">
                                <input type="date" class="filter-select" id="custom-date-to" style="flex: 1;">
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="generateCustomReport()">
                        üìä Generate Custom Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- KYC Review Modal -->
    <div class="modal" id="kyc-review-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeKYCReviewModal()">&times;</button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #4a5568; font-size: 1.8rem; font-weight: 700; margin-bottom: 10px;">
                    üõ°Ô∏è KYC Document Review
                </h2>
                <p style="color: #718096;" id="kyc-user-info">Review KYC submission for user verification</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 30px;">
                <div>
                    <h3 style="color: #4a5568; margin-bottom: 15px; text-align: center;">üìÑ Front ID</h3>
                    <div class="document-preview">
                        <img id="front-id-preview" class="document-image" alt="Front ID" src="">
                    </div>
                </div>
                <div>
                    <h3 style="color: #4a5568; margin-bottom: 15px; text-align: center;">üìÑ Back ID</h3>
                    <div class="document-preview">
                        <img id="back-id-preview" class="document-image" alt="Back ID" src="">
                    </div>
                </div>
                <div>
                    <h3 style="color: #4a5568; margin-bottom: 15px; text-align: center;">üì∏ Selfie</h3>
                    <div class="document-preview">
                        <img id="selfie-preview" class="document-image" alt="Selfie" src="">
                    </div>
                </div>
            </div>

            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üìù Review Notes</h4>
                <textarea id="review-notes" placeholder="Add your review notes here..." style="width: 100%; height: 100px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-approve" onclick="approveKYC()">
                    ‚úÖ Approve KYC
                </button>
                <button class="btn btn-reject" onclick="rejectKYC()">
                    ‚ùå Reject KYC
                </button>
                <button class="btn" onclick="closeKYCReviewModal()" style="background: #718096;">
                    üìã Review Later
                </button>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="user-details-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeUserDetailsModal()">&times;</button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <div id="user-modal-avatar" class="user-avatar" style="width: 80px; height: 80px; font-size: 2rem; margin: 0 auto 15px;"></div>
                <h2 style="color: #4a5568; font-size: 1.8rem; font-weight: 700; margin-bottom: 5px;" id="user-modal-name">User Name</h2>
                <p style="color: #718096;" id="user-modal-email">user@example.com</p>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="user-profile">üë§ Profile</button>
                <button class="tab" data-tab="user-transactions">üí∞ Transactions</button>
                <button class="tab" data-tab="user-activity">üìä Activity</button>
            </div>

            <div class="tab-content active" id="user-profile">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Phone</label>
                        <p id="user-modal-phone" style="color: #2d3748;">-</p>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Country</label>
                        <p id="user-modal-country" style="color: #2d3748;">-</p>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Balance</label>
                        <p id="user-modal-balance" style="color: #2d3748;">‚Çµ0</p>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Daily Rate</label>
                        <p id="user-modal-rate" style="color: #2d3748;">‚Çµ0</p>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">KYC Status</label>
                        <span id="user-modal-kyc" class="status-badge">-</span>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Member Since</label>
                        <p id="user-modal-created" style="color: #2d3748;">-</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="user-transactions">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="user-transactions-table">
                            <!-- User transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-content" id="user-activity">
                <div class="chart-container">
                    <div>üìä User activity charts will be displayed here</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Complaint Details Modal -->
    <div class="modal" id="complaint-details-modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="close-btn" onclick="closeComplaintDetailsModal()">&times;</button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #4a5568; font-size: 1.8rem; font-weight: 700; margin-bottom: 10px;">
                    üìû Complaint Details
                </h2>
                <p style="color: #718096;" id="complaint-modal-subtitle">Review and respond to customer complaint</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Customer</label>
                    <div id="complaint-modal-user" style="display: flex; align-items: center; gap: 10px;">
                        <div id="complaint-user-avatar" class="user-avatar" style="width: 30px; height: 30px; font-size: 0.9rem;"></div>
                        <div>
                            <div id="complaint-user-name" style="font-weight: 600; color: #2d3748;"></div>
                            <div id="complaint-user-email" style="font-size: 0.875rem; color: #718096;"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Category</label>
                    <span id="complaint-modal-category" class="status-badge">-</span>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Priority</label>
                    <span id="complaint-modal-priority" class="status-badge">-</span>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Status</label>
                    <span id="complaint-modal-status" class="status-badge">-</span>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Date Reported</label>
                    <p id="complaint-modal-date" style="color: #2d3748;">-</p>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Complaint ID</label>
                    <p id="complaint-modal-id" style="color: #2d3748; font-family: monospace; font-size: 0.9rem;">-</p>
                </div>
            </div>

            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üìù Subject</h4>
                <p id="complaint-modal-subject" style="color: #2d3748; font-weight: 600; font-size: 1.1rem;">-</p>
            </div>

            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üìã Description</h4>
                <p id="complaint-modal-description" style="color: #2d3748; line-height: 1.6;">-</p>
            </div>

            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;" id="complaint-screenshot-section" style="display: none;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üì∏ Screenshot</h4>
                <div style="text-align: center;">
                    <img id="complaint-screenshot" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 2px solid #e2e8f0;" src="" alt="Complaint Screenshot">
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="complaint-response">üí¨ Response</button>
                <button class="tab" data-tab="complaint-history">üìã History</button>
            </div>

            <div class="tab-content active" id="complaint-response">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Update Status</label>
                    <select id="complaint-status-update" class="filter-select" style="width: 200px; margin-bottom: 15px;">
                        <option value="open">Open</option>
                        <option value="in_progress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Admin Response</label>
                    <textarea id="complaint-response-text" placeholder="Type your response to the customer..." style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568;">Priority Level</label>
                    <select id="complaint-priority-update" class="filter-select" style="width: 200px;">
                        <option value="low">Low Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="high">High Priority</option>
                    </select>
                </div>
            </div>

            <div class="tab-content" id="complaint-history">
                <div id="complaint-history-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Complaint history will be populated here -->
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button class="btn btn-approve" onclick="updateComplaint()">
                    üíæ Update Complaint
                </button>
                <button class="btn" onclick="sendComplaintResponse()" style="background: #4299e1;">
                    üìß Send Response
                </button>
                <button class="btn" onclick="closeComplaintDetailsModal()" style="background: #718096;">
                    ‚ùå Close
                </button>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal" id="transaction-details-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeTransactionDetailsModal()">&times;</button>
            
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #4a5568; font-size: 1.8rem; font-weight: 700; margin-bottom: 10px;" id="transaction-modal-title">
                    üí∞ Transaction Details
                </h2>
                <p style="color: #718096;" id="transaction-modal-subtitle">Review transaction request details</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">User</label>
                    <p id="transaction-modal-user" style="color: #2d3748;">-</p>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Type</label>
                    <span id="transaction-modal-type" class="status-badge">-</span>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Amount</label>
                    <p id="transaction-modal-amount" style="color: #2d3748; font-weight: 600; font-size: 1.2rem;">‚Çµ0</p>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Current Balance</label>
                    <p id="transaction-modal-balance" style="color: #2d3748;">‚Çµ0</p>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Requested</label>
                    <p id="transaction-modal-date" style="color: #2d3748;">-</p>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568;">Commission</label>
                    <p id="transaction-modal-commission" style="color: #2d3748;">‚Çµ0</p>
                </div>
            </div>

            <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h4 style="color: #4a5568; margin-bottom: 15px;">üìù Description</h4>
                <p id="transaction-modal-description" style="color: #2d3748;">-</p>
            </div>

            <div style="background: #fff5f5; padding: 20px; border-radius: 10px; margin-bottom: 30px;" id="withdrawal-warning" style="display: none;">
                <h4 style="color: #c53030; margin-bottom: 15px;">‚ö†Ô∏è Withdrawal Warning</h4>
                <p style="color: #742a2a;">Please verify user identity and ensure sufficient balance before approval.</p>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-approve" id="approve-transaction-btn">
                    ‚úÖ Approve
                </button>
                <button class="btn btn-reject" id="reject-transaction-btn">
                    ‚ùå Reject
                </button>
                <button class="btn" onclick="closeTransactionDetailsModal()" style="background: #718096;">
                    üìã Review Later
                </button>
            </div>
        </div>
    </div>
  <script type="module">  
// SusuPay Admin Dashboard ‚Äì Consolidated JS with fixes

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, getDocs, setDoc, doc, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAoomGKHjU2iUJjjMxEDGCsLzRtIkHtqhY",
  authDomain: "susupay-5286e.firebaseapp.com",
  projectId: "susupay-5286e",
  storageBucket: "susupay-5286e.firebasestorage.app",
  messagingSenderId: "83852132974",
  appId: "1:83852132974:web:2d8be2d1adb7e7639f5c7f",
  measurementId: "G-EQM64CTX83"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const analytics = getAnalytics(app);

// App state
let allUsers = [];
let allApprovals = [];
let allComplaints = [];
let filteredUsers = [];
let filteredApprovals = [];
let filteredComplaints = [];
let currentPage = 1;
let itemsPerPage = 10;
let currentSection = "dashboard";
let currentUser = null;
let selectedKYCUser = null;
let selectedTransaction = null;
let selectedComplaint = null;
let selectedApprovals = new Set();

// Month names
const months = {
  1: "January", 2: "February", 3: "March", 4: "April", 5: "May", 6: "June",
  7: "July", 8: "August", 9: "September", 10: "October", 11: "November", 12: "December"
};

// Admin credentials (move to secure config in production)
const adminCredentials = {
  email: "fullword17@gmail.com",
  password: "admin123"
};

// ===== UI helpers =====
function showAlert(message, type) {
  const container = document.getElementById("alert-container");
  const alert = document.createElement("div");
  alert.className = `alert alert-${type}`;
  alert.textContent = message;
  container.appendChild(alert);
  setTimeout(() => alert.remove(), 5000);
}
function showLoading(sectionId) {
  const loading = document.getElementById(`${sectionId}-loading`);
  if (loading) loading.style.display = "block";
}
function hideLoading(sectionId) {
  const loading = document.getElementById(`${sectionId}-loading`);
  if (loading) loading.style.display = "none";
}
function initializeNavigation() {
  document.querySelectorAll(".nav-item").forEach(item => {
    item.addEventListener("click", e => switchSection(e.target.dataset.section));
  });
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", e => switchTab(e.target.dataset.tab));
  });
}
function switchSection(sectionName) {
  document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
  document.querySelector(`[data-section="${sectionName}"]`)?.classList.add("active");
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(`${sectionName}-section`)?.classList.add("active");
  currentSection = sectionName;
  loadSectionData(sectionName);
}
function switchTab(tabName) {
  const activeTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
  const container = activeTab.closest(".section, .modal-content");
  container.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  activeTab.classList.add("active");
  container.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
  document.getElementById(tabName)?.classList.add("active");
}
function updatePagination(section, totalItems) {
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const container = document.getElementById(`${section}-pagination`);
  if (!container || totalPages <= 1) {
    if (container) container.innerHTML = "";
    return;
  }
  let html = "";
  if (currentPage > 1) html += `<button class="page-btn" onclick="changePage(${currentPage - 1}, '${section}')">‚Äπ Previous</button>`;
  for (let i = 1; i <= totalPages; i++) {
    if (i === currentPage) html += `<button class="page-btn active">${i}</button>`;
    else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) html += `<button class="page-btn" onclick="changePage(${i}, '${section}')">${i}</button>`;
    else if (i === currentPage - 3 || i === currentPage + 3) html += `<span>...</span>`;
  }
  if (currentPage < totalPages) html += `<button class="page-btn" onclick="changePage(${currentPage + 1}, '${section}')">Next ‚Ä∫</button>`;
  container.innerHTML = html;
}
window.changePage = function (page, section) {
  currentPage = page;
  if (section === "users") displayUsers();
};

// ===== Data loading switchboard =====
async function loadSectionData(sectionName) {
  switch (sectionName) {
    case "dashboard": await loadDashboardData(); break;
    case "users": await loadUsers(); break;
    case "kyc": await loadKYCSubmissions(); break;
    case "transactions": await loadTransactions(); break;
    case "complaints": await loadComplaints(); break;
    case "reports": await loadReports(); break;
    case "approvals": await loadPendingApprovals(); break;
  }
}

// ===== Dashboard =====
async function loadDashboardData() {
  try {
    if (allUsers.length === 0) {
      const usersSnapshot = await getDocs(collection(db, "users"));
      allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    const users = allUsers;

    const totalUsers = users.length;
    const pendingKYC = users.filter(u => u.kycStatus === "pending").length;

    let pendingApprovals = 0;
    users.forEach(user => {
      pendingApprovals += (user.transactions?.filter(t => t.status === "pending") || []).length;
      if (user.contributions) {
        Object.values(user.contributions).forEach(monthContribs => {
          if (monthContribs && typeof monthContribs === "object") {
            Object.values(monthContribs).forEach(contrib => {
              if (typeof contrib === "object" && contrib.status === "pending") pendingApprovals++;
            });
          }
        });
      }
    });

    const totalVolume = users.reduce((sum, user) => {
      let approved = 0;
      if (user.contributions) {
        Object.values(user.contributions).forEach(monthContribs => {
          if (monthContribs && typeof monthContribs === "object") {
            Object.values(monthContribs).forEach(contrib => {
              if (typeof contrib === "object" && contrib.status === "approved") approved += (contrib.amount || 0);
              else if (typeof contrib === "number") approved += contrib;
            });
          }
        });
      }
      return sum + approved;
    }, 0);

    const totalRevenue = users.reduce((sum, user) => {
      const approvedWithdrawals = user.transactions?.filter(t => t.type === "withdrawal" && t.status === "approved") || [];
      return sum + approvedWithdrawals.reduce((s, t) => s + (t.commission || 0), 0);
    }, 0);

    // Update stat cards
    document.getElementById("total-users").textContent = totalUsers;
    document.getElementById("pending-kyc").textContent = pendingKYC;
    document.getElementById("total-transactions").textContent = `‚Çµ${totalVolume.toLocaleString()}`;
    document.getElementById("platform-revenue").textContent = `‚Çµ${totalRevenue.toLocaleString()}`;

    const approvalsNavItem = document.querySelector('[data-section="approvals"]');
    if (approvalsNavItem) {
      approvalsNavItem.innerHTML = pendingApprovals > 0
        ? `‚è≥ Approvals <span style="background:#e53e3e;color:#fff;border-radius:50%;padding:2px 8px;font-size:.75rem;margin-left:5px;animation:pulse 2s infinite;">${pendingApprovals}</span>`
        : "‚è≥ Approvals";
    }

    loadRecentActivity(users);
  } catch (e) {
    console.error("Error loading dashboard:", e);
    showAlert("Failed to load dashboard data", "error");
  }
}

// Recent Activity (with de-dupe guard against mirrored contribution transactions)
function loadRecentActivity(users) {
  const recent = [];
  const transactionKeys = new Set();

  users.forEach(user => {
    const txs = user.transactions || [];
    txs.forEach(t => {
      const time = t.requestedAt || t.date || new Date().toISOString();
      const minuteKey = new Date(time).toISOString().slice(0, 16);
      const key = `${user.id}|${t.type}|${Number(t.amount) || 0}|${minuteKey}`;
      transactionKeys.add(key);
      recent.push({
        time,
        user: `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email,
        action: t.type,
        amount: `‚Çµ${(t.amount || 0).toLocaleString()}`,
        status: t.status || "approved"
      });
    });

    if (user.contributions) {
      Object.values(user.contributions).forEach(monthContribs => {
        if (monthContribs && typeof monthContribs === "object") {
          Object.values(monthContribs).forEach(contrib => {
            if (typeof contrib === "object") {
              const cTime = contrib.requestedAt || contrib.date || new Date().toISOString();
              const minuteKey = new Date(cTime).toISOString().slice(0, 16);
              const key = `${user.id}|contribution|${Number(contrib.amount) || 0}|${minuteKey}`;
              if (transactionKeys.has(key)) return; // skip duplicate
              recent.push({
                time: cTime,
                user: `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email,
                action: "contribution",
                amount: `‚Çµ${(contrib.amount || 0).toLocaleString()}`,
                status: contrib.status || "approved"
              });
            }
          });
        }
      });
    }
  });

  recent.sort((a, b) => new Date(b.time) - new Date(a.time));
  const body = document.getElementById("recent-activity-table");
  if (recent.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="5" class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>No recent activity to display</p>
        </td>
      </tr>`;
  } else {
    body.innerHTML = recent.slice(0, 10).map(a => `
      <tr>
        <td>${new Date(a.time).toLocaleString()}</td>
        <td>${a.user}</td>
        <td><span class="status-badge ${a.action === "contribution" ? "status-verified" : "status-pending"}">${a.action.charAt(0).toUpperCase() + a.action.slice(1)}</span></td>
        <td>${a.amount}</td>
        <td><span class="status-badge status-${a.status}">${a.status.charAt(0).toUpperCase() + a.status.slice(1)}</span></td>
      </tr>`).join("");
  }
}

// ===== Approvals (deduping + stable IDs) =====
async function loadPendingApprovals() {
  try {
    showLoading("approvals");
    const pending = [];
    const seen = new Set(); // userId|type|amount|minuteKey

    allUsers.forEach(user => {
      const txs = user.transactions?.filter(t => t.status === "pending") || [];
      txs.forEach((t, index) => {
        const id = t.id || t.transactionId || `tx_${user.id}_${index}`;
        const requestedAt = t.requestedAt || t.date || new Date().toISOString();
        const minuteKey = new Date(requestedAt).toISOString().slice(0, 16);
        const key = `${user.id}|${t.type}|${Number(t.amount) || 0}|${minuteKey}`;
        if (seen.has(key)) return;
        seen.add(key);
        pending.push({
          ...t,
          userId: user.id,
          userName: `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email,
          userEmail: user.email,
          userPhone: user.phone || "N/A",
          userBalance: user.balance || 0,
          requestedAt,
          transactionId: id,
          originalIndex: index
        });
      });

      if (user.contributions) {
        Object.entries(user.contributions).forEach(([month, monthContribs]) => {
          if (monthContribs && typeof monthContribs === "object") {
            Object.entries(monthContribs).forEach(([day, contrib]) => {
              if (typeof contrib === "object" && contrib.status === "pending") {
                const requestedAt = contrib.requestedAt || contrib.date || new Date().toISOString();
                const minuteKey = new Date(requestedAt).toISOString().slice(0, 16);
                const key = `${user.id}|contribution|${Number(contrib.amount) || 0}|${minuteKey}`;
                if (seen.has(key)) return;
                seen.add(key);
                pending.push({
                  ...contrib,
                  userId: user.id,
                  userName: `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email,
                  userEmail: user.email,
                  userPhone: user.phone || "N/A",
                  userBalance: user.balance || 0,
                  month: parseInt(month, 10),
                  day: parseInt(day, 10),
                  date: `${months[month]} ${day}, ${new Date().getFullYear()}`,
                  requestedAt,
                  transactionId: `contribution_${user.id}_${month}_${day}`,
                  type: "contribution"
                });
              }
            });
          }
        });
      }
    });

    pending.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));

    allApprovals = pending;
    filteredApprovals = [...pending];
    displayPendingApprovals();
    setupApprovalFilters();
    hideLoading("approvals");
  } catch (e) {
    console.error("Error loading pending approvals:", e);
    showAlert("Failed to load pending approvals", "error");
    hideLoading("approvals");
  }
}
function displayPendingApprovals() {
  const body = document.getElementById("approvals-table");
  if (filteredApprovals.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="7" class="empty-state">
          <div class="empty-state-icon">‚è≥</div>
          <p>No pending approvals found</p>
        </td>
      </tr>`;
  } else {
    body.innerHTML = filteredApprovals.map(a => `
      <tr>
        <td><input type="checkbox" class="approval-checkbox" data-approval-id="${a.transactionId}" data-user-id="${a.userId}" onchange="toggleApprovalSelection(this)"></td>
        <td>
          <div class="user-info">
            <div class="user-avatar">${(a.userName || a.userEmail || "U")[0].toUpperCase()}</div>
            <div class="user-details">
              <div class="user-name">${a.userName}</div>
              <div class="user-email">${a.userEmail}</div>
            </div>
          </div>
        </td>
        <td><span class="status-badge ${a.type === "contribution" ? "status-verified" : "status-pending"}">${a.type.charAt(0).toUpperCase() + a.type.slice(1)}</span></td>
        <td>
          <strong style="color:#2d3748;">‚Çµ${(a.amount || 0).toLocaleString()}</strong>
          ${a.commission ? `<br><small style="color:#718096;">Fee: ‚Çµ${a.commission}</small>` : ""}
          ${a.type === "withdrawal" && a.totalDeduction ? `<br><small style="color:#e53e3e;">Total: ‚Çµ${a.totalDeduction}</small>` : ""}
        </td>
        <td>${new Date(a.requestedAt).toLocaleString()}</td>
        <td>
          <small style="color:#718096;line-height:1.4;">
            ${a.description || "No description provided"}<br>
            <strong>Balance:</strong> ‚Çµ${(a.userBalance || 0).toLocaleString()}<br>
            <strong>Phone:</strong> ${a.userPhone}
            ${a.type === "withdrawal" ? `<br><span style="color:#e53e3e;">‚ö†Ô∏è Withdrawal Request</span>` : ""}
          </small>
        </td>
        <td>
          <div style="display:flex;gap:5px;flex-wrap:wrap;">
            <button class="btn btn-approve btn-small" onclick="showTransactionDetails('${a.userId}', '${a.transactionId}', '${a.type}')">üëÅÔ∏è Review</button>
            <button class="btn btn-approve btn-small" onclick="quickApproveTransaction('${a.userId}', '${a.transactionId}', '${a.type}')">‚úÖ Quick Approve</button>
            <button class="btn btn-reject btn-small" onclick="quickRejectTransaction('${a.userId}', '${a.transactionId}', '${a.type}')">‚ùå Reject</button>
          </div>
        </td>
      </tr>`).join("");
  }
  updateApprovalCountBadge();
}
function setupApprovalFilters() {
  const searchInput = document.getElementById("approval-search");
  const typeFilter = document.getElementById("approval-type-filter");
  const amountFilter = document.getElementById("approval-amount-filter");
  const apply = () => {
    let f = [...allApprovals];
    const term = searchInput?.value?.toLowerCase() || "";
    if (term) f = f.filter(a => (a.userName || "").toLowerCase().includes(term) || (a.userEmail || "").toLowerCase().includes(term));
    const t = typeFilter?.value || "";
    if (t) f = f.filter(a => a.type === t);
    const amt = amountFilter?.value || "";
    if (amt) {
      f = f.filter(a => {
        const v = a.amount || 0;
        if (amt === "small") return v < 100;
        if (amt === "medium") return v >= 100 && v <= 500;
        if (amt === "large") return v > 500;
        return true;
      });
    }
    filteredApprovals = f;
    displayPendingApprovals();
  };
  if (searchInput) searchInput.addEventListener("input", apply);
  if (typeFilter) typeFilter.addEventListener("change", apply);
  if (amountFilter) amountFilter.addEventListener("change", apply);
}
function updateApprovalCountBadge() {
  const approvalsNavItem = document.querySelector('[data-section="approvals"]');
  const count = allApprovals.length;
  if (approvalsNavItem) {
    approvalsNavItem.innerHTML = count > 0
      ? `‚è≥ Approvals <span style="background:#e53e3e;color:#fff;border-radius:50%;padding:2px 8px;font-size:.75rem;margin-left:5px;animation:pulse 2s infinite;">${count}</span>`
      : "‚è≥ Approvals";
  }
}

// ===== Users =====
async function loadUsers() {
  try {
    showLoading("users");
    if (allUsers.length === 0) {
      const usersSnapshot = await getDocs(collection(db, "users"));
      allUsers = usersSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    filteredUsers = [...allUsers];
    displayUsers();
    setupUserFilters();
    hideLoading("users");
  } catch (e) {
    console.error("Error loading users:", e);
    showAlert("Failed to load users", "error");
    hideLoading("users");
  }
}
function displayUsers() {
  const body = document.getElementById("users-table");
  const start = (currentPage - 1) * itemsPerPage;
  const pageUsers = filteredUsers.slice(start, start + itemsPerPage);
  if (pageUsers.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="7" class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <p>No users found</p>
        </td>
      </tr>`;
  } else {
    body.innerHTML = pageUsers.map(user => `
      <tr>
        <td>
          <div class="user-info">
            <div class="user-avatar">${(user.firstName || user.email || "U")[0].toUpperCase()}</div>
            <div class="user-details">
              <div class="user-name">${`${user.firstName || ""} ${user.middleName || ""} ${user.surname || ""}`.trim()}</div>
              <div class="user-email">${user.email || ""}</div>
            </div>
          </div>
        </td>
        <td>${getCountryFlag(user.country)} ${user.country || "N/A"}</td>
        <td>${user.phone || "N/A"}</td>
        <td>‚Çµ${(user.balance || 0).toLocaleString()}</td>
        <td><span class="status-badge status-${user.kycStatus || "not-started"}">${getKYCStatusText(user.kycStatus)}</span></td>
        <td><span class="status-badge ${user.emailVerified ? "status-verified" : "status-pending"}">${user.emailVerified ? "Verified" : "Unverified"}</span></td>
        <td><button class="btn btn-small" onclick="viewUserDetails('${user.id}')">üëÅÔ∏è View</button></td>
      </tr>`).join("");
  }
  updatePagination("users", filteredUsers.length);
}
function setupUserFilters() {
  const searchInput = document.getElementById("user-search");
  const statusFilter = document.getElementById("user-status-filter");
  const kycFilter = document.getElementById("kyc-status-filter");
  const apply = () => {
    const term = searchInput?.value?.toLowerCase() || "";
    const status = statusFilter?.value || "";
    const kyc = kycFilter?.value || "";
    filteredUsers = allUsers.filter(user => {
      const matchesTerm =
        !term ||
        (user.firstName || "").toLowerCase().includes(term) ||
        (user.surname || "").toLowerCase().includes(term) ||
        (user.email || "").toLowerCase().includes(term) ||
        (user.phone || "").toLowerCase().includes(term);
      const matchesStatus =
        !status ||
        (status === "verified" && user.emailVerified) ||
        (status === "unverified" && !user.emailVerified);
      const matchesKyc = !kyc || user.kycStatus === kyc;
      return matchesTerm && matchesStatus && matchesKyc;
    });
    currentPage = 1;
    displayUsers();
  };
  if (searchInput) searchInput.addEventListener("input", apply);
  if (statusFilter) statusFilter.addEventListener("change", apply);
  if (kycFilter) kycFilter.addEventListener("change", apply);
}

// ===== KYC =====
async function loadKYCSubmissions() {
  try {
    showLoading("kyc");
    const filterVal = document.getElementById("kyc-filter")?.value || "pending";
    const kycUsers = filterVal === "all"
      ? allUsers.filter(u => u.kycStatus && u.kycStatus !== "not_started")
      : allUsers.filter(u => u.kycStatus === filterVal);
    displayKYCSubmissions(kycUsers);
    hideLoading("kyc");
  } catch (e) {
    console.error("Error loading KYC submissions:", e);
    showAlert("Failed to load KYC submissions", "error");
    hideLoading("kyc");
  }
}
function displayKYCSubmissions(kycUsers) {
  const body = document.getElementById("kyc-table");
  if (kycUsers.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="5" class="empty-state">
          <div class="empty-state-icon">üõ°Ô∏è</div>
          <p>No KYC submissions found</p>
        </td>
      </tr>`;
  } else {
    body.innerHTML = kycUsers.map(user => `
      <tr>
        <td>
          <div class="user-info">
            <div class="user-avatar">${(user.firstName || user.email || "U")[0].toUpperCase()}</div>
            <div class="user-details">
              <div class="user-name">${`${user.firstName || ""} ${user.surname || ""}`.trim()}</div>
              <div class="user-email">${user.email || ""}</div>
            </div>
          </div>
        </td>
        <td>${user.updatedAt ? new Date(user.updatedAt.seconds * 1000).toLocaleDateString() : "N/A"}</td>
        <td>
          ${user.kycDocuments?.frontId ? "üìÑ" : "‚ùå"} Front ID<br>
          ${user.kycDocuments?.backId ? "üìÑ" : "‚ùå"} Back ID<br>
          ${user.kycDocuments?.selfie ? "üì∏" : "‚ùå"} Selfie
        </td>
        <td><span class="status-badge status-${user.kycStatus}">${getKYCStatusText(user.kycStatus)}</span></td>
        <td>
          <button class="btn btn-small" onclick="reviewKYC('${user.id}')">${user.kycStatus === "pending" ? "üëÅÔ∏è Review" : "üëÅÔ∏è View"}</button>
        </td>
      </tr>`).join("");
  }
}

// ===== Transactions (list + filters) =====
async function loadTransactions() {
  try {
    showLoading("transactions");
    const tx = [];
    allUsers.forEach(user => {
      (user.transactions || []).forEach(t => {
        tx.push({
          ...t,
          userId: user.id,
          userName: `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email,
          userEmail: user.email
        });
      });
    });
    tx.sort((a, b) => new Date(b.requestedAt || b.date) - new Date(a.requestedAt || a.date));
    displayTransactions(tx);
    setupTransactionFilters(tx);
    hideLoading("transactions");
  } catch (e) {
    console.error("Error loading transactions:", e);
    showAlert("Failed to load transactions", "error");
    hideLoading("transactions");
  }
}
function displayTransactions(transactions) {
  const body = document.getElementById("transactions-table");
  if (transactions.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="6" class="empty-state">
          <div class="empty-state-icon">üí∞</div>
          <p>No transactions found</p>
        </td>
      </tr>`;
  } else {
    body.innerHTML = transactions.slice(0, 50).map(t => `
      <tr>
        <td>${new Date(t.requestedAt || t.date).toLocaleDateString()}</td>
        <td>
          <div class="user-details">
            <div class="user-name">${t.userName}</div>
            <div class="user-email">${t.userEmail}</div>
          </div>
        </td>
        <td><span class="status-badge ${t.type === "contribution" ? "status-verified" : "status-pending"}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</span></td>
        <td>‚Çµ${(t.amount || 0).toLocaleString()}</td>
        <td>‚Çµ${(t.commission || 0).toLocaleString()}</td>
        <td><span class="status-badge status-${t.status || "approved"}">${(t.status || "approved").charAt(0).toUpperCase() + (t.status || "approved").slice(1)}</span></td>
      </tr>`).join("");
  }
}
function setupTransactionFilters(allTransactions) {
  const searchInput = document.getElementById("transaction-search");
  const typeFilter = document.getElementById("transaction-type-filter");
  const dateFromInput = document.getElementById("date-from");
  const dateToInput = document.getElementById("date-to");
  const apply = () => {
    let f = [...allTransactions];
    const term = searchInput?.value?.toLowerCase() || "";
    if (term) f = f.filter(t => t.userName.toLowerCase().includes(term) || t.userEmail.toLowerCase().includes(term));
    const t = typeFilter?.value || "";
    if (t) f = f.filter(x => x.type === t);
    const from = dateFromInput?.value || "";
    const to = dateToInput?.value || "";
    if (from) f = f.filter(x => new Date(x.requestedAt || x.date) >= new Date(from));
    if (to) f = f.filter(x => new Date(x.requestedAt || x.date) <= new Date(to));
    displayTransactions(f);
  };
  if (searchInput) searchInput.addEventListener("input", apply);
  if (typeFilter) typeFilter.addEventListener("change", apply);
  if (dateFromInput) dateFromInput.addEventListener("change", apply);
  if (dateToInput) dateToInput.addEventListener("change", apply);
}

// ===== Complaints =====
async function loadComplaints() {
  try {
    showLoading("complaints");
    if (allComplaints.length === 0) {
      const complaintsSnapshot = await getDocs(collection(db, "complaints"));
      allComplaints = complaintsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    filteredComplaints = [...allComplaints];
    displayComplaints();
    setupComplaintFilters();
    hideLoading("complaints");
  } catch (e) {
    console.error("Error loading complaints:", e);
    showAlert("Failed to load complaints", "error");
    hideLoading("complaints");
  }
}
function displayComplaints() {
  const body = document.getElementById("complaints-table");
  if (filteredComplaints.length === 0) {
    body.innerHTML = `
      <tr>
        <td colspan="8" class="empty-state">
          <div class="empty-state-icon">üìû</div>
          <p>No complaints found</p>
        </td>
      </tr>`;
  } else {
    body.innerHTML = filteredComplaints.map(c => {
      const user = allUsers.find(u => u.id === c.userId);
      const userName = user ? `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email : "Unknown User";
      const userEmail = user ? user.email : "Unknown";
      return `
      <tr>
        <td>
          <div class="user-info">
            <div class="user-avatar">${(userName || userEmail || "U")[0].toUpperCase()}</div>
            <div class="user-details">
              <div class="user-name">${userName}</div>
              <div class="user-email">${userEmail}</div>
            </div>
          </div>
        </td>
        <td><span class="status-badge ${getCategoryBadgeClass(c.category)}">${formatCategory(c.category)}</span></td>
        <td><span class="status-badge ${getPriorityBadgeClass(c.priority)}">${formatPriority(c.priority)}</span></td>
        <td>
          <div style="max-width:200px;">
            <div style="font-weight:600;color:#2d3748;margin-bottom:5px;">${c.subject || "No Subject"}</div>
            <div style="font-size:.875rem;color:#718096;line-height:1.3;">${truncateText(c.description || "No description", 80)}</div>
          </div>
        </td>
        <td><span class="status-badge status-${c.status || "open"}">${formatStatus(c.status)}</span></td>
        <td>${new Date(c.createdAt?.seconds * 1000 || c.createdAt).toLocaleDateString()}</td>
        <td>${c.updatedAt ? new Date(c.updatedAt?.seconds * 1000 || c.updatedAt).toLocaleDateString() : "Never"}</td>
        <td>
          <div style="display:flex;gap:5px;flex-wrap:wrap;">
            <button class="btn btn-small" onclick="viewComplaintDetails('${c.id}')">üëÅÔ∏è View</button>
            ${(c.status === "open" || c.status === "in_progress") ? `<button class="btn btn-approve btn-small" onclick="quickResolveComplaint('${c.id}')">‚úÖ Resolve</button>` : ""}
          </div>
        </td>
      </tr>`;
    }).join("");
  }
}
function setupComplaintFilters() {
  const searchInput = document.getElementById("complaints-search");
  const statusFilter = document.getElementById("complaints-status-filter");
  const categoryFilter = document.getElementById("complaints-category-filter");
  const priorityFilter = document.getElementById("complaints-priority-filter");
  const dateFromInput = document.getElementById("complaints-date-from");
  const dateToInput = document.getElementById("complaints-date-to");
  const apply = () => {
    let f = [...allComplaints];
    const term = searchInput?.value?.toLowerCase() || "";
    if (term) {
      f = f.filter(c => {
        const user = allUsers.find(u => u.id === c.userId);
        const name = user ? `${user.firstName || ""} ${user.surname || ""}`.trim() : "";
        const email = user ? user.email : "";
        return name.toLowerCase().includes(term) ||
               email.toLowerCase().includes(term) ||
               (c.subject || "").toLowerCase().includes(term) ||
               (c.description || "").toLowerCase().includes(term);
      });
    }
    const st = statusFilter?.value || "";
    if (st) f = f.filter(c => c.status === st);
    const cat = categoryFilter?.value || "";
    if (cat) f = f.filter(c => c.category === cat);
    const pr = priorityFilter?.value || "";
    if (pr) f = f.filter(c => c.priority === pr);
    const from = dateFromInput?.value || "";
    const to = dateToInput?.value || "";
    if (from) f = f.filter(c => new Date(c.createdAt?.seconds * 1000 || c.createdAt) >= new Date(from));
    if (to) f = f.filter(c => new Date(c.createdAt?.seconds * 1000 || c.createdAt) <= new Date(to));
    filteredComplaints = f;
    displayComplaints();
  };
  if (searchInput) searchInput.addEventListener("input", apply);
  if (statusFilter) statusFilter.addEventListener("change", apply);
  if (categoryFilter) categoryFilter.addEventListener("change", apply);
  if (priorityFilter) priorityFilter.addEventListener("change", apply);
  if (dateFromInput) dateFromInput.addEventListener("change", apply);
  if (dateToInput) dateToInput.addEventListener("change", apply);
}
function updateComplaintCountBadge() {
  const nav = document.querySelector('[data-section="complaints"]');
  const open = allComplaints.filter(c => c.status === "open" || c.status === "in_progress").length;
  if (nav) {
    nav.innerHTML = open > 0
      ? `üìû Complaints <span style="background:#e53e3e;color:#fff;border-radius:50%;padding:2px 8px;font-size:.75rem;margin-left:5px;animation:pulse 2s infinite;">${open}</span>`
      : "üìû Complaints";
  }
}

// ===== Approve/Reject flows and Modals =====
window.showTransactionDetails = function (userId, transactionId, type) {
  const user = allUsers.find(u => u.id === userId);
  if (!user) return showAlert("User not found", "error");

  let transaction;
  if (type === "contribution") {
    const parts = transactionId.split("_"); // contribution_userId_month_day
    const month = parts[2];
    const day = parts[3];
    transaction = user.contributions?.[month]?.[day];
    if (transaction && typeof transaction === "object") {
      transaction.type = "contribution";
      transaction.transactionId = transactionId;
    }
  } else {
    transaction = user.transactions?.find(t => t.id === transactionId || t.transactionId === transactionId);
  }
  if (!transaction) return showAlert("Transaction not found", "error");

  selectedTransaction = { ...transaction, userId, type };

  document.getElementById("transaction-modal-title").textContent = `${type.charAt(0).toUpperCase() + type.slice(1)} Request Details`;
  document.getElementById("transaction-modal-subtitle").textContent = `Review ${type} request from ${user.firstName || ""} ${user.surname || ""}`;
  document.getElementById("transaction-modal-user").textContent = `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email;
  const typeBadge = document.getElementById("transaction-modal-type");
  typeBadge.textContent = type.charAt(0).toUpperCase() + type.slice(1);
  typeBadge.className = `status-badge ${type === "contribution" ? "status-verified" : "status-pending"}`;
  document.getElementById("transaction-modal-amount").textContent = `‚Çµ${(transaction.amount || 0).toLocaleString()}`;
  document.getElementById("transaction-modal-balance").textContent = `‚Çµ${(user.balance || 0).toLocaleString()}`;
  document.getElementById("transaction-modal-date").textContent = new Date(transaction.requestedAt || transaction.date || new Date()).toLocaleString();
  document.getElementById("transaction-modal-commission").textContent = `‚Çµ${(transaction.commission || 0).toLocaleString()}`;
  document.getElementById("transaction-modal-description").textContent = transaction.description || "No description provided";

  const warning = document.getElementById("withdrawal-warning");
  warning.style.display = type === "withdrawal" ? "block" : "none";

  document.getElementById("approve-transaction-btn").onclick = () => approveCurrentTransaction();
  document.getElementById("reject-transaction-btn").onclick = () => rejectCurrentTransaction();

  document.getElementById("transaction-details-modal").style.display = "block";
  document.body.style.overflow = "hidden";
};
window.closeTransactionDetailsModal = function () {
  document.getElementById("transaction-details-modal").style.display = "none";
  document.body.style.overflow = "auto";
  selectedTransaction = null;
};

async function approveCurrentTransaction() {
  if (!selectedTransaction) return;
  try {
    await approveTransaction(selectedTransaction.userId, selectedTransaction.transactionId || selectedTransaction.id, selectedTransaction.type);
    closeTransactionDetailsModal();
  } catch (e) {
    console.error("Error approving transaction:", e);
    showAlert("Failed to approve transaction", "error");
  }
}
async function rejectCurrentTransaction() {
  if (!selectedTransaction) return;
  const reason = prompt("Please provide a reason for rejection:");
  if (!reason || !reason.trim()) return showAlert("Rejection reason is required", "error");
  try {
    await rejectTransaction(selectedTransaction.userId, selectedTransaction.transactionId || selectedTransaction.id, selectedTransaction.type, reason.trim());
    closeTransactionDetailsModal();
  } catch (e) {
    console.error("Error rejecting transaction:", e);
    showAlert("Failed to reject transaction", "error");
  }
}
window.quickApproveTransaction = async function (userId, transactionId, type) {
  if (confirm(`Are you sure you want to approve this ${type}?`)) await approveTransaction(userId, transactionId, type);
};
window.quickRejectTransaction = async function (userId, transactionId, type) {
  const reason = prompt(`Please provide a reason for rejecting this ${type}:`);
  if (reason && reason.trim()) await rejectTransaction(userId, transactionId, type, reason.trim());
};

async function approveTransaction(userId, transactionId, type) {
  try {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return showAlert("User not found", "error");

    const u = JSON.parse(JSON.stringify(user));
    let found = false;

    if (type === "contribution") {
      const parts = transactionId.split("_"); // contribution_userId_month_day
      const month = parts[2];
      const day = parts[3];
      if (u.contributions?.[month]?.[day] && typeof u.contributions[month][day] === "object" && u.contributions[month][day].status === "pending") {
        const contrib = u.contributions[month][day];
        contrib.status = "approved";
        contrib.approvedAt = new Date().toISOString();
        contrib.approvedBy = currentUser?.email;
        u.balance = (u.balance || 0) + (contrib.amount || 0);

        if (Array.isArray(u.transactions)) {
          const idx = u.transactions.findIndex(t => t.status === "pending" && t.type === "contribution" && Number(t.amount) === Number(contrib.amount));
          if (idx !== -1) {
            u.transactions[idx].status = "approved";
            u.transactions[idx].approvedAt = new Date().toISOString();
            u.transactions[idx].approvedBy = currentUser?.email;
          }
        }
        found = true;
      }
    } else if (type === "withdrawal") {
      if (Array.isArray(u.transactions)) {
        let idx = u.transactions.findIndex(t => (t.id === transactionId || t.transactionId === transactionId) && t.status === "pending" && t.type === "withdrawal");
        if (idx === -1) {
          const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId && a.type === "withdrawal");
          if (approval && approval.originalIndex !== undefined) {
            idx = approval.originalIndex;
            if (u.transactions[idx]?.status !== "pending" || u.transactions[idx]?.type !== "withdrawal") idx = -1;
          }
        }
        if (idx === -1) {
          const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId);
          if (approval) {
            idx = u.transactions.findIndex(t =>
              t.status === "pending" &&
              t.type === "withdrawal" &&
              Number(t.amount) === Number(approval.amount) &&
              Math.abs(new Date(t.requestedAt || t.date) - new Date(approval.requestedAt)) < 60000
            );
          }
        }
        if (idx !== -1) {
          const t = u.transactions[idx];
          t.status = "approved";
          t.approvedAt = new Date().toISOString();
          t.approvedBy = currentUser?.email;
          const deduction = (t.amount || 0) + (t.commission || 0);
          u.balance = Math.max(0, (u.balance || 0) - deduction);
          found = true;
        }
      }
    } else {
      if (Array.isArray(u.transactions)) {
        let idx = u.transactions.findIndex(t => (t.id === transactionId || t.transactionId === transactionId) && t.status === "pending");
        if (idx === -1) {
          const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId);
          if (approval?.originalIndex !== undefined && u.transactions[approval.originalIndex]?.status === "pending") idx = approval.originalIndex;
        }
        if (idx !== -1) {
          u.transactions[idx].status = "approved";
          u.transactions[idx].approvedAt = new Date().toISOString();
          u.transactions[idx].approvedBy = currentUser?.email;
          found = true;
        }
      }
    }

    if (!found) return showAlert("Transaction not found or already processed", "error");

    await updateDoc(doc(db, "users", userId), {
      balance: u.balance,
      contributions: u.contributions,
      transactions: u.transactions,
      updatedAt: new Date()
    });

    const ix = allUsers.findIndex(x => x.id === userId);
    if (ix !== -1) allUsers[ix] = u;

    showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} approved successfully`, "success");
    await loadPendingApprovals();
    loadDashboardData();
  } catch (e) {
    console.error("Error approving transaction:", e);
    showAlert("Failed to approve transaction", "error");
  }
}
async function rejectTransaction(userId, transactionId, type, reason) {
  try {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return showAlert("User not found", "error");

    const u = JSON.parse(JSON.stringify(user));
    let found = false;

    if (type === "contribution") {
      const parts = transactionId.split("_"); // contribution_userId_month_day
      const month = parts[2];
      const day = parts[3];
      if (u.contributions?.[month]?.[day] && typeof u.contributions[month][day] === "object" && u.contributions[month][day].status === "pending") {
        const contrib = u.contributions[month][day];
        contrib.status = "rejected";
        contrib.rejectedAt = new Date().toISOString();
        contrib.rejectedBy = currentUser?.email;
        contrib.rejectionReason = reason;

        if (Array.isArray(u.transactions)) {
          u.transactions.forEach((t, idx) => {
            if (t.type === "contribution" && t.status === "pending" && (t.date?.includes(months[month]) && t.date?.includes(day))) {
              u.transactions[idx].status = "rejected";
              u.transactions[idx].rejectedAt = new Date().toISOString();
              u.transactions[idx].rejectedBy = currentUser?.email;
              u.transactions[idx].rejectionReason = reason;
            }
          });
        }
        found = true;
      }
    } else if (type === "withdrawal") {
      if (Array.isArray(u.transactions)) {
        let idx = u.transactions.findIndex(t => (t.id === transactionId || t.transactionId === transactionId) && t.status === "pending" && t.type === "withdrawal");
        if (idx === -1) {
          const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId && a.type === "withdrawal");
          if (approval?.originalIndex !== undefined && u.transactions[approval.originalIndex]?.status === "pending" && u.transactions[approval.originalIndex]?.type === "withdrawal") {
            idx = approval.originalIndex;
          }
        }
        if (idx === -1) {
          const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId);
          if (approval) {
            idx = u.transactions.findIndex(t =>
              t.status === "pending" &&
              t.type === "withdrawal" &&
              Number(t.amount) === Number(approval.amount) &&
              Math.abs(new Date(t.requestedAt || t.date) - new Date(approval.requestedAt)) < 60000
            );
          }
        }
        if (idx !== -1) {
          u.transactions[idx].status = "rejected";
          u.transactions[idx].rejectedAt = new Date().toISOString();
          u.transactions[idx].rejectedBy = currentUser?.email;
          u.transactions[idx].rejectionReason = reason;
          found = true;
        }
      }
    } else {
      if (Array.isArray(u.transactions)) {
        let idx = u.transactions.findIndex(t => (t.id === transactionId || t.transactionId === transactionId) && t.status === "pending");
        if (idx === -1) {
          const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId);
          if (approval?.originalIndex !== undefined && u.transactions[approval.originalIndex]?.status === "pending") idx = approval.originalIndex;
        }
        if (idx !== -1) {
          u.transactions[idx].status = "rejected";
          u.transactions[idx].rejectedAt = new Date().toISOString();
          u.transactions[idx].rejectedBy = currentUser?.email;
          u.transactions[idx].rejectionReason = reason;
          found = true;
        }
      }
    }

    if (!found) {
      const ai = allApprovals.findIndex(a => a.userId === userId && (a.transactionId === transactionId || a.id === transactionId));
      if (ai !== -1) {
        allApprovals.splice(ai, 1);
        filteredApprovals = [...allApprovals];
        displayPendingApprovals();
        updateApprovalCountBadge();
        showAlert("Transaction removed from approvals list", "success");
        return;
      }
      return showAlert("Transaction not found or already processed", "error");
    }

    await updateDoc(doc(db, "users", userId), {
      contributions: u.contributions,
      transactions: u.transactions,
      updatedAt: new Date()
    });

    const ix = allUsers.findIndex(x => x.id === userId);
    if (ix !== -1) allUsers[ix] = u;

    const ai = allApprovals.findIndex(a => a.userId === userId && (a.transactionId === transactionId || a.id === transactionId));
    if (ai !== -1) {
      allApprovals.splice(ai, 1);
      filteredApprovals = [...allApprovals];
      displayPendingApprovals();
      updateApprovalCountBadge();
    }

    showAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} rejected successfully`, "success");
    await loadPendingApprovals();
    loadDashboardData();
  } catch (e) {
    console.error("Error rejecting transaction:", e);
    showAlert("Failed to reject transaction", "error");
  }
}

// ===== Selection & bulk approve =====
window.toggleApprovalSelection = function (checkbox) {
  const approvalId = checkbox.dataset.approvalId;
  const userId = checkbox.dataset.userId;
  if (checkbox.checked) selectedApprovals.add(`${userId}_${approvalId}`);
  else selectedApprovals.delete(`${userId}_${approvalId}`);

  const bulkBtn = document.getElementById("approve-all-btn");
  if (bulkBtn) bulkBtn.style.display = selectedApprovals.size > 0 ? "block" : "none";

  const selectAll = document.getElementById("select-all-approvals");
  if (selectAll) {
    const all = document.querySelectorAll(".approval-checkbox");
    const checked = document.querySelectorAll(".approval-checkbox:checked");
    selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
    selectAll.checked = checked.length === all.length;
  }
};
window.toggleAllApprovals = function (selectAll) {
  const boxes = document.querySelectorAll(".approval-checkbox");
  selectedApprovals.clear();
  boxes.forEach(cb => {
    cb.checked = selectAll.checked;
    if (selectAll.checked) selectedApprovals.add(`${cb.dataset.userId}_${cb.dataset.approvalId}`);
  });
  const bulkBtn = document.getElementById("approve-all-btn");
  if (bulkBtn) bulkBtn.style.display = selectedApprovals.size > 0 ? "block" : "none";
};
window.approveAllSelected = async function () {
  if (selectedApprovals.size === 0) return showAlert("No approvals selected", "error");
  if (!confirm(`Are you sure you want to approve ${selectedApprovals.size} selected transactions?`)) return;
  const tasks = [];
  selectedApprovals.forEach(sel => {
    const [userId, transactionId] = sel.split("_", 2);
    const approval = allApprovals.find(a => a.userId === userId && a.transactionId === transactionId);
    if (approval) tasks.push(approveTransaction(userId, transactionId, approval.type));
  });
  try {
    await Promise.all(tasks);
    selectedApprovals.clear();
    showAlert(`Successfully approved ${tasks.length} transactions`, "success");
    const bulkBtn = document.getElementById("approve-all-btn");
    if (bulkBtn) bulkBtn.style.display = "none";
    const selectAll = document.getElementById("select-all-approvals");
    if (selectAll) selectAll.checked = false;
  } catch (e) {
    console.error("Error approving selected transactions:", e);
    showAlert("Some transactions failed to approve", "error");
  }
};

// ===== Complaints modals and actions =====
window.viewComplaintDetails = function (complaintId) {
  const complaint = allComplaints.find(c => c.id === complaintId);
  if (!complaint) return showAlert("Complaint not found", "error");

  const user = allUsers.find(u => u.id === complaint.userId);
  selectedComplaint = complaint;

  document.getElementById("complaint-modal-subtitle").textContent = `Complaint #${complaint.id.substring(0, 8).toUpperCase()}`;
  if (user) {
    document.getElementById("complaint-user-avatar").textContent = (user.firstName || user.email || "U")[0].toUpperCase();
    document.getElementById("complaint-user-name").textContent = `${user.firstName || ""} ${user.surname || ""}`.trim() || "Unknown User";
    document.getElementById("complaint-user-email").textContent = user.email || "Unknown";
  } else {
    document.getElementById("complaint-user-avatar").textContent = "U";
    document.getElementById("complaint-user-name").textContent = "Unknown User";
    document.getElementById("complaint-user-email").textContent = "Unknown";
  }

  const categoryBadge = document.getElementById("complaint-modal-category");
  categoryBadge.textContent = formatCategory(complaint.category);
  categoryBadge.className = `status-badge ${getCategoryBadgeClass(complaint.category)}`;

  const priorityBadge = document.getElementById("complaint-modal-priority");
  priorityBadge.textContent = formatPriority(complaint.priority);
  priorityBadge.className = `status-badge ${getPriorityBadgeClass(complaint.priority)}`;

  const statusBadge = document.getElementById("complaint-modal-status");
  statusBadge.textContent = formatStatus(complaint.status);
  statusBadge.className = `status-badge status-${complaint.status || "open"}`;

  document.getElementById("complaint-modal-date").textContent = new Date(complaint.createdAt?.seconds * 1000 || complaint.createdAt).toLocaleString();
  document.getElementById("complaint-modal-id").textContent = complaint.id;
  document.getElementById("complaint-modal-subject").textContent = complaint.subject || "No Subject";
  document.getElementById("complaint-modal-description").textContent = complaint.description || "No description provided";

  const screenshotSection = document.getElementById("complaint-screenshot-section");
  const screenshotImg = document.getElementById("complaint-screenshot");
  if (complaint.screenshot) {
    screenshotImg.src = complaint.screenshot;
    screenshotImg.onerror = () => { screenshotSection.style.display = "none"; };
    screenshotSection.style.display = "block";
  } else {
    screenshotSection.style.display = "none";
  }

  document.getElementById("complaint-status-update").value = complaint.status || "open";
  document.getElementById("complaint-priority-update").value = complaint.priority || "medium";
  document.getElementById("complaint-response-text").value = "";

  loadComplaintHistory(complaint);

  // Reset tabs
  const responseTab = document.querySelector('.tab[data-tab="complaint-response"]');
  const historyTab = document.querySelector('.tab[data-tab="complaint-history"]');
  const responseContent = document.getElementById("complaint-response");
  const historyContent = document.getElementById("complaint-history");
  if (responseTab && historyTab && responseContent && historyContent) {
    responseTab.classList.add("active");
    historyTab.classList.remove("active");
    responseContent.classList.add("active");
    responseContent.style.display = "block";
    historyContent.classList.remove("active");
    historyContent.style.display = "none";
  }

  document.getElementById("complaint-details-modal").style.display = "block";
  document.body.style.overflow = "hidden";
};
window.closeComplaintDetailsModal = function () {
  document.getElementById("complaint-details-modal").style.display = "none";
  document.body.style.overflow = "auto";
  selectedComplaint = null;
};
function loadComplaintHistory(complaint) {
  const list = document.getElementById("complaint-history-list");
  const history = complaint.history || [];
  if (history.length === 0) {
    list.innerHTML = `
      <div class="empty-state" style="padding:30px;">
        <div class="empty-state-icon">üìã</div>
        <p>No history available</p>
      </div>`;
  } else {
    list.innerHTML = [...history].reverse().map(entry => `
      <div style="background:#f7fafc;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #667eea;">
        <div style="display:flex;justify-content:between;align-items:center;margin-bottom:10px;">
          <div style="font-weight:600;color:#2d3748;">${entry.action}</div>
          <div style="font-size:.875rem;color:#718096;">${new Date(entry.timestamp?.seconds * 1000 || entry.timestamp).toLocaleString()}</div>
        </div>
        <div style="color:#4a5568;margin-bottom:8px;">${entry.message || "No message"}</div>
        <div style="font-size:.8rem;color:#718096;">By: ${entry.adminEmail || "System"}</div>
      </div>`).join("");
  }
}
window.updateComplaint = async function () {
  if (!selectedComplaint) return;
  try {
    const newStatus = document.getElementById("complaint-status-update").value;
    const newPriority = document.getElementById("complaint-priority-update").value;
    const responseText = document.getElementById("complaint-response-text").value.trim();
    const updatedData = {
      status: newStatus,
      priority: newPriority,
      updatedAt: new Date(),
      lastUpdatedBy: currentUser?.email
    };
    const historyEntry = {
      action: "Status Updated",
      message: `Status changed to ${formatStatus(newStatus)}, Priority set to ${formatPriority(newPriority)}${responseText ? ". Admin response added." : ""}`,
      timestamp: new Date(),
      adminEmail: currentUser?.email
    };
    if (responseText) {
      updatedData.lastResponse = responseText;
      updatedData.lastResponseAt = new Date();
    }
    updatedData.history = [...(selectedComplaint.history || []), historyEntry];

    await updateDoc(doc(db, "complaints", selectedComplaint.id), updatedData);
    const idx = allComplaints.findIndex(c => c.id === selectedComplaint.id);
    if (idx !== -1) allComplaints[idx] = { ...allComplaints[idx], ...updatedData };

    showAlert("Complaint updated successfully", "success");
    closeComplaintDetailsModal();
    displayComplaints();
    loadDashboardData();
  } catch (e) {
    console.error("Error updating complaint:", e);
    showAlert("Failed to update complaint", "error");
  }
};
window.sendComplaintResponse = async function () {
  if (!selectedComplaint) return;
  const responseText = document.getElementById("complaint-response-text").value.trim();
  if (!responseText) return showAlert("Please enter a response message", "error");
  try {
    const updatedData = {
      lastResponse: responseText,
      lastResponseAt: new Date(),
      updatedAt: new Date(),
      lastUpdatedBy: currentUser?.email,
      status: "in_progress"
    };
    const historyEntry = {
      action: "Response Sent",
      message: `Admin response: "${responseText}"`,
      timestamp: new Date(),
      adminEmail: currentUser?.email
    };
    updatedData.history = [...(selectedComplaint.history || []), historyEntry];

    await updateDoc(doc(db, "complaints", selectedComplaint.id), updatedData);
    const idx = allComplaints.findIndex(c => c.id === selectedComplaint.id);
    if (idx !== -1) allComplaints[idx] = { ...allComplaints[idx], ...updatedData };

    showAlert("Response sent successfully", "success");
    document.getElementById("complaint-response-text").value = "";
    document.getElementById("complaint-status-update").value = "in_progress";
    loadComplaintHistory({ ...selectedComplaint, ...updatedData });
  } catch (e) {
    console.error("Error sending response:", e);
    showAlert("Failed to send response", "error");
  }
};
window.quickResolveComplaint = async function (complaintId) {
  if (!confirm("Are you sure you want to mark this complaint as resolved?")) return;
  try {
    const updatedData = {
      status: "resolved",
      updatedAt: new Date(),
      lastUpdatedBy: currentUser?.email
    };
    const historyEntry = {
      action: "Quick Resolution",
      message: "Complaint marked as resolved",
      timestamp: new Date(),
      adminEmail: currentUser?.email
    };
    updatedData.history = [...(allComplaints.find(c => c.id === complaintId)?.history || []), historyEntry];

    await updateDoc(doc(db, "complaints", complaintId), updatedData);
    const idx = allComplaints.findIndex(c => c.id === complaintId);
    if (idx !== -1) allComplaints[idx] = { ...allComplaints[idx], ...updatedData };

    showAlert("Complaint resolved successfully", "success");
    displayComplaints();
    loadDashboardData();
  } catch (e) {
    console.error("Error resolving complaint:", e);
    showAlert("Failed to resolve complaint", "error");
  }
};

// ===== Utility =====
function formatCategory(category) {
  const map = {
    login_auth: "Login/Authentication",
    transaction: "Transaction Problems",
    kyc: "KYC Verification",
    technical: "Technical Problems",
    other: "Other"
  };
  return map[category] || "Unknown";
}
function getCategoryBadgeClass(category) {
  const map = {
    login_auth: "status-pending",
    transaction: "status-rejected",
    kyc: "status-verified",
    technical: "status-approved",
    other: "status-not-started"
  };
  return map[category] || "status-not-started";
}
function formatPriority(priority) {
  const map = { high: "High Priority", medium: "Medium Priority", low: "Low Priority" };
  return map[priority] || "Medium Priority";
}
function getPriorityBadgeClass(priority) {
  const map = { high: "status-rejected", medium: "status-pending", low: "status-approved" };
  return map[priority] || "status-pending";
}
function formatStatus(status) {
  const map = { open: "Open", in_progress: "In Progress", resolved: "Resolved", closed: "Closed" };
  return map[status] || "Open";
}
function truncateText(text, maxLength) {
  if (!text) return "";
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + "...";
}
function getCountryFlag(countryCode) {
  const flags = { US:"üá∫üá∏", GB:"üá¨üáß", GH:"üá¨üá≠", NG:"üá≥üá¨", KE:"üá∞üá™", ZA:"üáøüá¶", CA:"üá®üá¶", AU:"üá¶üá∫", DE:"üá©üá™", FR:"üá´üá∑", IT:"üáÆüáπ", ES:"üá™üá∏", BR:"üáßüá∑", MX:"üá≤üáΩ", AR:"üá¶üá∑", IN:"üáÆüá≥", CN:"üá®üá≥", JP:"üáØüáµ", KR:"üá∞üá∑", SG:"üá∏üá¨" };
  return flags[countryCode] || "üåç";
}
function getKYCStatusText(status) {
  const map = { not_started: "Not Started", pending: "Pending", approved: "Approved", rejected: "Rejected" };
  return map[status] || "Unknown";
}

// ===== KYC modal actions =====
window.viewUserDetails = function (userId) {
  const user = allUsers.find(u => u.id === userId);
  if (!user) return;
  document.getElementById("user-modal-avatar").textContent = (user.firstName || user.email || "U")[0].toUpperCase();
  document.getElementById("user-modal-name").textContent = `${user.firstName || ""} ${user.middleName || ""} ${user.surname || ""}`.trim() || "Unknown";
  document.getElementById("user-modal-email").textContent = user.email || "";
  document.getElementById("user-modal-phone").textContent = user.phone || "N/A";
  document.getElementById("user-modal-country").textContent = user.country || "N/A";
  document.getElementById("user-modal-balance").textContent = `‚Çµ${(user.balance || 0).toLocaleString()}`;
  document.getElementById("user-modal-rate").textContent = `‚Çµ${user.dailyRate || 0}`;
  document.getElementById("user-modal-created").textContent = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : "N/A";
  const kycBadge = document.getElementById("user-modal-kyc");
  kycBadge.textContent = getKYCStatusText(user.kycStatus);
  kycBadge.className = `status-badge status-${user.kycStatus || "not-started"}`;

  const table = document.getElementById("user-transactions-table");
  const txs = user.transactions || [];
  if (txs.length === 0) {
    table.innerHTML = `
      <tr>
        <td colspan="4" class="empty-state">
          <div class="empty-state-icon">üí∞</div>
          <p>No transactions found</p>
        </td>
      </tr>`;
  } else {
    table.innerHTML = txs.slice(0, 10).map(t => `
      <tr>
        <td>${new Date(t.requestedAt || t.date).toLocaleDateString()}</td>
        <td><span class="status-badge ${t.type === "contribution" ? "status-verified" : "status-pending"}">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</span></td>
        <td>‚Çµ${(t.amount || 0).toLocaleString()}</td>
        <td>${t.description || "N/A"}</td>
      </tr>`).join("");
  }

  document.getElementById("user-details-modal").style.display = "block";
  document.body.style.overflow = "hidden";
};
window.closeUserDetailsModal = function () {
  document.getElementById("user-details-modal").style.display = "none";
  document.body.style.overflow = "auto";
};
window.reviewKYC = function (userId) {
  const user = allUsers.find(u => u.id === userId);
  if (!user || !user.kycDocuments) return showAlert("KYC documents not found", "error");
  selectedKYCUser = user;
  document.getElementById("kyc-user-info").textContent = `Review KYC submission for ${user.firstName || ""} ${user.surname || ""} (${user.email})`;
  if (user.kycDocuments.frontId) document.getElementById("front-id-preview").src = user.kycDocuments.frontId;
  if (user.kycDocuments.backId) document.getElementById("back-id-preview").src = user.kycDocuments.backId;
  if (user.kycDocuments.selfie) document.getElementById("selfie-preview").src = user.kycDocuments.selfie;
  document.getElementById("review-notes").value = "";
  document.getElementById("kyc-review-modal").style.display = "block";
  document.body.style.overflow = "hidden";
};
window.closeKYCReviewModal = function () {
  document.getElementById("kyc-review-modal").style.display = "none";
  document.body.style.overflow = "auto";
  selectedKYCUser = null;
};
window.approveKYC = async function () {
  if (!selectedKYCUser) return;
  try {
    await updateDoc(doc(db, "users", selectedKYCUser.id), {
      kycStatus: "approved",
      kycReviewNotes: document.getElementById("review-notes").value,
      kycReviewedAt: new Date(),
      kycReviewedBy: currentUser?.email
    });
    const idx = allUsers.findIndex(u => u.id === selectedKYCUser.id);
    if (idx !== -1) allUsers[idx].kycStatus = "approved";
    showAlert("KYC approved successfully", "success");
    closeKYCReviewModal();
    loadKYCSubmissions();
    loadDashboardData();
  } catch (e) {
    console.error("Error approving KYC:", e);
    showAlert("Failed to approve KYC", "error");
  }
};
window.rejectKYC = async function () {
  if (!selectedKYCUser) return;
  const notes = document.getElementById("review-notes").value;
  if (!notes.trim()) return showAlert("Please provide rejection notes", "error");
  try {
    await updateDoc(doc(db, "users", selectedKYCUser.id), {
      kycStatus: "rejected",
      kycReviewNotes: notes,
      kycReviewedAt: new Date(),
      kycReviewedBy: currentUser?.email
    });
    const idx = allUsers.findIndex(u => u.id === selectedKYCUser.id);
    if (idx !== -1) allUsers[idx].kycStatus = "rejected";
    showAlert("KYC rejected", "success");
    closeKYCReviewModal();
    loadKYCSubmissions();
    loadDashboardData();
  } catch (e) {
    console.error("Error rejecting KYC:", e);
    showAlert("Failed to reject KYC", "error");
  }
};

// ===== Exports =====
window.exportUsers = function () {
  const csv = "data:text/csv;charset=utf-8," +
    "Name,Email,Phone,Country,Balance,KYC Status,Email Verified,Created Date\n" +
    allUsers.map(u => [
      `"${`${u.firstName || ""} ${u.surname || ""}`.trim()}"`,
      u.email || "",
      u.phone || "",
      u.country || "",
      u.balance || 0,
      u.kycStatus || "not_started",
      u.emailVerified ? "Yes" : "No",
      u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString() : ""
    ].join(",")).join("\n");
  const link = document.createElement("a");
  link.href = encodeURI(csv);
  link.download = "susupay_users.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
window.exportTransactions = function () {
  const allTx = [];
  allUsers.forEach(user => {
    (user.transactions || []).forEach(t => {
      allTx.push({ ...t, userName: `${user.firstName || ""} ${user.surname || ""}`.trim() || user.email, userEmail: user.email });
    });
  });
  const csv = "data:text/csv;charset=utf-8," +
    "Date,User Name,User Email,Type,Amount,Commission,Description\n" +
    allTx.map(t => [
      `"${t.requestedAt || t.date}"`,
      `"${t.userName}"`,
      `"${t.userEmail}"`,
      t.type,
      t.amount || 0,
      t.commission || 0,
      `"${t.description || ""}"`
    ].join(",")).join("\n");
  const link = document.createElement("a");
  link.href = encodeURI(csv);
  link.download = "susupay_transactions.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// ===== Reports =====
async function loadReports() {
  try {
    const today = new Date();
    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const todayRegistrations = allUsers.filter(u => {
      const c = u.createdAt ? new Date(u.createdAt.seconds * 1000) : null;
      return c && c >= todayStart;
    }).length;
    const todayTransactions = allUsers.reduce((total, u) => {
      const tx = u.transactions || [];
      return total + tx.filter(t => new Date(t.requestedAt || t.date) >= todayStart)
                       .reduce((s, t) => s + (t.amount || 0), 0);
    }, 0);
    const todayKYC = allUsers.filter(u => {
      const upd = u.updatedAt ? new Date(u.updatedAt.seconds * 1000) : null;
      return upd && upd >= todayStart && u.kycStatus === "pending";
    }).length;
    const todayRevenue = allUsers.reduce((total, u) => {
      const tx = u.transactions || [];
      return total + tx.filter(t => new Date(t.requestedAt || t.date) >= todayStart)
                       .reduce((s, t) => s + (t.commission || 0), 0);
    }, 0);

    document.getElementById("today-registrations").textContent = todayRegistrations;
    document.getElementById("today-transactions").textContent = `‚Çµ${todayTransactions.toLocaleString()}`;
    document.getElementById("today-kyc").textContent = todayKYC;
    document.getElementById("today-revenue").textContent = `‚Çµ${todayRevenue.toLocaleString()}`;
  } catch (e) {
    console.error("Error loading reports:", e);
    showAlert("Failed to load reports", "error");
  }
}
window.refreshDashboard = function () { loadDashboardData(); };
window.refreshKYC = function () { loadKYCSubmissions(); };
window.refreshApprovals = function () { loadPendingApprovals(); };
window.refreshComplaints = function () { loadComplaints(); };
window.generateReports = function () { showAlert("Generating comprehensive reports...", "success"); loadReports(); };
window.generateCustomReport = function () {
  const type = document.getElementById("custom-report-type")?.value;
  const from = document.getElementById("custom-date-from")?.value;
  const to = document.getElementById("custom-date-to")?.value;
  if (!from || !to) return showAlert("Please select date range for custom report", "error");
  showAlert(`Generating ${type} report from ${from} to ${to}...`, "success");
};

// ===== Admin Access =====
async function verifyAdminAccess(user) {
  if (!user) return false;
  try {
    if (user.email !== adminCredentials.email) return false;
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", user.email), where("isAdmin", "==", true));
    const snapshot = await getDocs(q);
    if (snapshot.empty) {
      await setDoc(doc(db, "users", user.uid), {
        email: user.email, isAdmin: true, createdAt: new Date().toISOString(), uid: user.uid, role: "admin"
      });
      return true;
    }
    const adminDoc = snapshot.docs[0];
    const adminData = adminDoc.data();
    if (adminDoc.id !== user.uid) {
      await setDoc(doc(db, "users", user.uid), { ...adminData, uid: user.uid, lastUpdated: new Date().toISOString() });
    }
    return true;
  } catch (e) {
    console.error("Error verifying admin access:", e);
    return false;
  }
}
function showAdminLogin() {
  const adminContainer = document.querySelector(".admin-container");
  if (adminContainer) window.originalAdminHTML = adminContainer.outerHTML;
  document.body.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">
      <div style="background:rgba(255,255,255,0.95);border-radius:20px;padding:40px;box-shadow:0 15px 40px rgba(0,0,0,0.2);backdrop-filter:blur(10px);width:100%;max-width:400px;text-align:center;">
        <h1 style="color:#4a5568;font-size:2rem;font-weight:700;margin-bottom:10px;">üè¶ SusuPay Admin</h1>
        <p style="color:#718096;margin-bottom:30px;">Administrator Access Required</p>
        <div id="admin-alert-container"></div>
        <form id="admin-login-form">
          <div style="margin-bottom:20px;text-align:left;">
            <label style="display:block;margin-bottom:8px;color:#4a5568;font-weight:600;">Admin Email</label>
            <input type="email" id="admin-email" required style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
          </div>
          <div style="margin-bottom:20px;text-align:left;">
            <label style="display:block;margin-bottom:8px;color:#4a5568;font-weight:600;">Admin Password</label>
            <input type="password" id="admin-password" required style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
          </div>
          <button type="submit" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:14px 25px;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600;width:100%;">üîê Admin Login</button>
        </form>
      </div>
    </div>
  `;
  document.getElementById("admin-login-form").addEventListener("submit", handleAdminLogin);
}
function isAdmin(email) {
  return email === adminCredentials.email;
}
async function handleAdminLogin(e) {
  e.preventDefault();
  const email = document.getElementById("admin-email").value;
  const password = document.getElementById("admin-password").value;
  if (!isAdmin(email)) {
    document.getElementById("admin-alert-container").innerHTML = `<div style="padding:12px;border-radius:8px;margin-bottom:20px;font-weight:500;background:#fed7d7;color:#742a2a;border:1px solid #feb2b2;">Access denied. Admin credentials required.</div>`;
    return;
  }
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch {
    document.getElementById("admin-alert-container").innerHTML = `<div style="padding:12px;border-radius:8px;margin-bottom:20px;font-weight:500;background:#fed7d7;color:#742a2a;border:1px solid #feb2b2;">Invalid admin credentials.</div>`;
  }
}

// ===== App bootstrap =====
async function initializeAdminDashboard() {
  try {
    if (!window.originalAdminHTML) throw new Error("Admin dashboard content not found");
    document.body.innerHTML = window.originalAdminHTML;

    await loadUsers();
    const stats = await (async function calculateUserStats(users) {
      const stats = { totalUsers: users.length, verifiedUsers: 0, totalBalance: 0, activeUsers: 0, avgContribution: 0 };
      users.forEach(u => {
        if (u.kycStatus === "verified") stats.verifiedUsers++;
        if (u.balance) stats.totalBalance += u.balance;
        if (u.lastActive && (new Date() - new Date(u.lastActive)) < 30 * 24 * 60 * 60 * 1000) stats.activeUsers++;
      });
      if (stats.totalUsers > 0) stats.avgContribution = stats.totalBalance / stats.totalUsers;
      return stats;
    })(allUsers);
    (function updateDashboardStats(stats) {
      const elements = {
        "total-users": stats.totalUsers,
        "verified-users": stats.verifiedUsers,
        "total-balance": `‚Çµ${stats.totalBalance.toFixed(2)}`,
        "active-users": stats.activeUsers,
        "avg-contribution": `‚Çµ${stats.avgContribution.toFixed(2)}`
      };
      Object.entries(elements).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      });
    })(stats);

    await Promise.all([loadPendingApprovals(), loadComplaints()]);

    initializeNavigation();
    setupApprovalFilters();
    setupUserFilters();
    setupComplaintFilters();

    setupRealtimeListeners();
    switchSection("dashboard");

    // Logout
    const logoutBtn = document.getElementById("admin-logout");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try { await signOut(auth); location.reload(); } catch (e) { console.error("Logout error:", e); }
      });
    }
    const kycFilter = document.getElementById("kyc-filter");
    if (kycFilter) kycFilter.addEventListener("change", loadKYCSubmissions);
  } catch (e) {
    console.error("Error initializing admin dashboard:", e);
    showAlert("Failed to initialize admin dashboard. Please try again.", "error");
  }
}
function setupRealtimeListeners() {
  const usersRef = collection(db, "users");
  onSnapshot(usersRef, snapshot => {
    allUsers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    filteredUsers = [...allUsers];
    if (currentSection === "dashboard") loadDashboardData();
    if (currentSection === "approvals") loadPendingApprovals();
    if (currentSection === "users") displayUsers();
  });
  const complaintsRef = collection(db, "complaints");
  onSnapshot(complaintsRef, snapshot => {
    allComplaints = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    filteredComplaints = [...allComplaints];
    if (currentSection === "complaints") displayComplaints();
    updateComplaintCountBadge();
  });
}
async function checkAdminAccess() {
  let initialized = false;
  const adminContainer = document.querySelector(".admin-container");
  if (adminContainer) window.originalAdminHTML = adminContainer.outerHTML;

  const unsubscribe = onAuthStateChanged(auth, async user => {
    if (initialized) return;
    if (user) {
      try {
        const ok = await verifyAdminAccess(user);
        if (ok) {
          currentUser = user;
          await user.getIdToken(true);
          await initializeAdminDashboard();
          initialized = true;
        } else {
          showAdminLogin();
        }
      } catch {
        showAdminLogin();
      }
    } else {
      showAdminLogin();
    }
  });

  setTimeout(() => { if (!initialized) unsubscribe(); }, 10000);
}
checkAdminAccess();
</script>
    </body>
</html>

    

